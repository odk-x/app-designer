<!doctype html>
<!--

	There's a config in the `app/file_manager_config` file that should load automatically when you load the tab.
	It should load up a demo that will overwrite the "teatime.html" file.

	When you make a list view in the list view designer and hit save, it will get the files from the server, inject the new file,
	then save the files object back. When you switch to this tab, it will reload the files.

	The "Save Build Script" button will generate the  "app_specific_appnamehere.py" file in the formgen submodule,
	formgen repo, then run `grunt generate-formgen-files` to generate the list view that you made (and all of the other
	files you configured), checking for syntax errors as it goes
	
-->
<html>
	<head>
		<style>
textarea {
	min-width: 80%;
}
			body {
				background-color: white;
			}
		</style>
		<script src='constants.js'></script>
		<script>
			var files = [];
			var ol = function ol() {
				var right = document.getElementById("right");
				right.innerHTML = "";
				right.setAttribute("data-filename", "");
				document.getElementById("left").innerHTML = "Loading..."
				userLoad(true);
			}
			var redrawLeft = function redrawLeft() {
				var left = document.getElementById("left")
				var elems = left.getElementsByTagName("input");
				var saved = -1;
				for (var i = 0; i < elems.length; i++) {
					if (elems[i].checked) saved = i;
				}
				left.innerHTML = ""
				for (var i = 0; i < files.length; i++) {
					var _delete = document.createElement("button");
					_delete.innerText = "-";
					(function(name) {
						_delete.addEventListener("click", function() {
							delete_file(name);
						});
					})(files[i][0])
					var button = document.createElement("input")
					button.type = "radio";
					var id = "files-" + i.toString();
					button.id = id;
					button.name = "filelist";
					button.setAttribute("data-filename", files[i][0]);
					button.addEventListener("change", saveAndRedrawRight);
					button.checked = saved == i;
					var label = document.createElement("label")
					label.setAttribute("for", id);
					label.innerText = files[i][0];
					left.appendChild(_delete)
					left.appendChild(button)
					left.appendChild(label)
					left.appendChild(document.createElement("br"))
				}
			}
			var redrawRight = function redrawRight(file) {
				var fields = []
				if (file[1] == "table") {
					fields = ["HTML", "CSS", "Js On Load", "Js Search", "Js Generic"];
				} else if (file[1] == "detail") {
					fields = ["HTML", "CSS", "Js On Load", "Js Generic"];
				} else if (file[1] == "index") {
					fields = ["Js", "CSS"];
				} else if (file[1] == "tabs") {
					fields = ["Js", "CSS"];
				} else if (file[1] == "graph") {
					fields = ["CSS", "Js"];
				}
				var right = document.getElementById("right");
				right.setAttribute("data-filename", file[0]);
				right.innerHTML = "";
				for (var i = 0; i < fields.length; i++) {
					var label = document.createTextNode(fields[i]);
					var box = document.createElement("textarea");
					var text_in_box = file[i + 2];
					box.value = text_in_box;
					var height = 20 * text_in_box.split("\n").length;
					box.style.minHeight = height.toString() + "px";
					box.setAttribute("data-index", i + 2);
					right.appendChild(label);
					right.appendChild(document.createElement("br"));
					right.appendChild(box);
					right.appendChild(document.createElement("br"));
				}
			}
			var getRight = function getRight() {
				var right = document.getElementById("right");
				if (!right.hasAttribute("data-filename") || right.getAttribute("data-filename").length == 0) return; // nothing to get
				var filename = right.getAttribute("data-filename");
				var found = -1;
				for (var i = 0; i < files.length; i++) {
					if (files[i][0] == filename) {
						found = i;
						break;
					}
				}
				if (found == -1) {
					alert("File not found");
					return;
				}
				var fields = right.getElementsByTagName("textarea");
				for (var i = 0; i < fields.length; i++) {
					var index = Number(fields[i].getAttribute("data-index"));
					files[found][index] = fields[i].value;
				}
			}
			var saveAndRedrawRight = function saveAndRedrawRight() {
				getRight();
				var left = document.getElementById("left")
				var elems = left.getElementsByTagName("input")
				for (var i = 0; i < elems.length; i++) {
					if (elems[i].checked) {
						for (var j = 0; j < files.length; j++) {
							if (files[j][0] == elems[i].getAttribute("data-filename")) {
								redrawRight(files[j]);
								return;
							}
						}
					}
				}
				alert("Filename not found in left");
			}
			var addFile = function addFile(filename, type) {
				if (filename.length == 0) {
					alert("Filename is empty!");
					return;
				}
				for (var i = 0; i < files.length; i++) {
					if (files[i][0] == filename) {
						alert("A file with that name already exists");
						return;
					}
				}
				files = files.concat(0)
				files[files.length - 1] = [filename, type]
				if (type == "table") {
					files[files.length - 1] = files[files.length - 1].concat(["", "", "", "", ""]) // customHtml, customCss, customJsOl, customJsSearch, customJsGeneric
				} else if (type == "detail") {
					files[files.length - 1] = files[files.length - 1].concat(["", "", "", ""]) // customHtml, customCss, customJsOl, customJsGeneric
				} else if (type == "index") {
					files[files.length - 1] = files[files.length - 1].concat(["", ""]) // customJs, customCss
				} else if (type == "tabs") {
					files[files.length - 1] = files[files.length - 1].concat(["", ""]) // customJs, customCss
				} else if (type == "graph") {
					files[files.length - 1] = files[files.length - 1].concat(["", ""]) // customCss, customJs
				} else {
					alert("unknown file type: " + type)
				}
				redrawLeft();
			}
			var add = function add() {
				addFile(document.getElementById("filename").value, document.getElementById("type").selectedOptions[0].value)
				document.getElementById("filename").value = ""
			}
			var make_custom_py = function make_custom_py() {
				getRight();
				var retVal = "import sys;\n";
				retVal += "sys.path.append('.');\n";
				retVal += "import custom_helper;\n";
				retVal += "helper = custom_helper.helper();\n";
				for (var i = 0; i < files.length; i++) {
					var file = files[i];
					retVal += "helper.make_" + file[1] + "(" + JSON.stringify(file[0]) + ","
					file.slice(2).forEach(function(entry) {
						retVal += JSON.stringify(entry) + ",";
					})
					retVal = retVal.substr(0, retVal.length - 1); // chop off the trailing comma
					retVal += ");\n\n"
				}
				return retVal;
			}
			var userLoad = function(viaOl) {
				//("global", eval)(prompt("Please paste in your configuration (it starts with 'files = ')"))
				var request = new XMLHttpRequest();
				request.onreadystatechange = function() {
					if (request.readyState == XMLHttpRequest.DONE && request.status == 200) {
						files = JSON.parse(request.responseText)
						if (!viaOl) alert("Success")
						redrawLeft();
					}
				}
				request.open("GET", USER_CONFIG_LOCATION, true);
				request.send()
			}
			var userSavePy = function() {
				getRight();
				//give_user("# Copy and paste this into your app_specific_yourappnamehere.py file and run ./build yourappnamehere", make_custom_py());
				postFile(USER_PY_LOCATION, make_custom_py(), "Success - Please run `grunt build-formgen-files`")
			}
			var userSave = function() {
				getRight();
				//give_user("// Copy this to a safe place and enter it when you click Load", "files = " + JSON.stringify(files) + ";");
				postFile(USER_CONFIG_LOCATION, JSON.stringify(files));
			}
			var delete_file = function delete_file(name) {
				if (!confirm("Please confirm deletion of file: " + name)) return;
				for (var i = 0; i < files.length; i++) {
					if (files[i][0] == name) {
						files = files.slice(0, i).concat(files.slice(i + 1));
						break;
					}
				}
				var right = document.getElementById("right");
				var current_file_in_right = right.getAttribute("data-filename");
				if (current_file_in_right == name) {
					right.innerHTML = "";
					right.setAttribute("data-filename", "")
				}
				redrawLeft();
			}
filename

		</script>
	</head>
	<body onLoad='ol();'>
		<button id='savepy' onClick='userSavePy();'>Save Build Script</button>
		<button id='save' onClick='userSave();'>Save</button>
		<button id='load' onClick='userLoad(false);'>Load</button>
		<br />
		Add a new file: 
		<input type='text' id='filename' placeholder='filename' />
		<select id='type'>
			<option value='table'>List View</option>
			<option value='detail'>Detail View</option>
			<option value='index'>Menu</option>
			<option value='tabs'>Tabs</option>
			<option value='graph'>Graph</option>
		</select>
		<button onClick="add();">Add file</button>
		<div id="left">
		</div>
		<div id="right">
		</div>
	</body>
</html>

