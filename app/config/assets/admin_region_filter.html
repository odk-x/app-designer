
<!doctype html>
<html>
	<head>
		<script type="text/javascript" src="/coldchain/system/js/odkCommon.js"></script>
		<script type="text/javascript" src="/coldchain/system/js/odkData.js"></script>
		<script type="text/javascript" src="/coldchain/system/tables/js/odkTables.js"></script>
		<script type="text/javascript" src="formgen_common.js"></script>
		<script type="text/javascript" src="generate_common.js"></script>
		<link href="generate_index.css" rel="stylesheet" />
		<style>
		
body {
	background: url('/coldchain/config/assets/img/hallway.jpg') no-repeat center/cover fixed;
}
		</style>
		<script>
			var metadata = {};
			var list_views = {};
			var menu = ["Empty menu!", null, []];
			// BEGIN CONFIG
			
list_views = {
	"health_facility": "config/assets/aa_health_facility_list.html",
}

	var hash = window.location.hash.substr(1);
	var val = ""
	if (hash.indexOf(":") == -1) {
		val = odkCommon.getSessionVariable("val");
	} else {
		val = hash.split(":")[0];
		window.location.hash = "#" + hash.split(":").slice(1)
	}
	odkCommon.setSessionVariable("val", val);
	menu = ["Loading...", null, []];
	
	odkData.arbitraryQuery("health_facility", "SELECT * FROM health_facility WHERE admin_region LIKE ? OR regionLevel2 LIKE ? GROUP BY facility_type", [val, val], 100, 0, function(d) {
		if (d.getCount() == 0) {
			menu = [_tu("Admin region ") + val + _tu(" has no health facilities!"), null, []];
			doMenu();
		} else {
			var distinct_admin_regions = 0;
			var all_regions = [];
			for (var i = 0; i < d.getCount(); i++) {
				var this_admin_region = d.getData(i, "admin_region")
				if (all_regions.indexOf(this_admin_region) == -1) {
					all_regions = all_regions.concat(this_admin_region);
					distinct_admin_regions++;
				}
			}
			if (distinct_admin_regions == 1) {
				var val = d.getData(0, "admin_region");
				menu = [_tu("Filtering ") + val, null, []]
				for (var i = 0; i < d.getCount(); i++) {
					var ftype = d.getData(i, "facility_type")
					var where = "admin_region = ? AND facility_type = ?";
					var args = [val, ftype];
					menu[2] = menu[2].concat(0);
					(function(val, where, args) {
						menu[2][menu[2].length - 1] = ["View " + _tc(d, "facility_type", ftype) + "s", "_js", function() { odkTables.openTableToMapView(null, "health_facility", where, args, list_views["health_facility"] + "#health_facility/STATIC/SELECT *, (SELECT COUNT(*) FROM refrigerators WHERE facility_row_id = health_facility._id) AS refrigerator_count FROM health_facility WHERE " + where + "/" + JSON.stringify(args) + "/health facilities in the admin region ? of the type ?"); }]
					})(val, where, args);
				}
				doMenu();
			} else {
				var val = d.getData(0, "regionLevel2");
				menu = [_tu("Filtering ") + val, null, []]
				for (var i = 0; i < d.getCount(); i++) {
					var ftype = d.getData(i, "facility_type")
					var where = "regionLevel2 = ? AND facility_type = ?";
					var args = [val, ftype];
					menu[2] = menu[2].concat(0);
					(function(val, where, args) {
						menu[2][menu[2].length - 1] = [_tu("View ") + _tc(d, "facility_type", ftype) + "s", "_js", function() { odkTables.openTableToMapView(null, "health_facility", where, args, list_views["health_facility"] + "#health_facility/STATIC/SELECT *, (SELECT COUNT(*) FROM refrigerators WHERE facility_row_id = health_facility._id) AS refrigerator_count FROM health_facility WHERE " + where + "/" + JSON.stringify(args) + "/health facilities in the region level 2 ? of the type ?"); }]
					})(val, where, args);
				}
				doMenu();
			}
		}
	}, function(e) { alert(e); });
		
			// END CONFIG
		</script>
		<script src="generate_index.js"></script>
	</head>
	<body onLoad='ol();'>
		<div id="title" class="button"></div>
		<div id="list"></div>
	</body>
</html>
	